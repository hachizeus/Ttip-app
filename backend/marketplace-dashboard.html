<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTip Marketplace</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .filters { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .filter-group select, .filter-group input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
        .workers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .worker-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .worker-card:hover { transform: translateY(-2px); }
        .worker-header { display: flex; align-items: center; margin-bottom: 15px; }
        .worker-avatar { width: 50px; height: 50px; border-radius: 25px; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 15px; }
        .worker-info h3 { margin-bottom: 5px; color: #333; }
        .worker-info p { color: #666; font-size: 14px; }
        .worker-stats { display: flex; gap: 15px; margin-bottom: 15px; }
        .stat { text-align: center; }
        .stat-value { font-weight: bold; color: #667eea; }
        .stat-label { font-size: 12px; color: #666; }
        .worker-badges { display: flex; gap: 5px; margin-bottom: 15px; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; }
        .badge.verified { background: #e8f5e8; color: #2d5a2d; }
        .badge.featured { background: #fff3cd; color: #856404; }
        .worker-services { margin-bottom: 15px; }
        .service-tag { display: inline-block; background: #f8f9fa; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin: 2px; }
        .worker-actions { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #f8f9fa; color: #333; border: 1px solid #ddd; }
        .rating { color: #ffa500; }
        .leaderboard { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .leaderboard h3 { margin-bottom: 15px; color: #333; }
        .leaderboard-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .rank { width: 30px; font-weight: bold; color: #667eea; }
        .rank.gold { color: #ffd700; }
        .rank.silver { color: #c0c0c0; }
        .rank.bronze { color: #cd7f32; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: white; border: none; border-radius: 6px; cursor: pointer; }
        .tab.active { background: #667eea; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè™ TTip Marketplace</h1>
        <p>Discover amazing service workers in your area</p>
    </div>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('marketplace')">üè™ Marketplace</button>
            <button class="tab" onclick="showTab('leaderboards')">üèÜ Leaderboards</button>
            <button class="tab" onclick="showTab('achievements')">üèÖ Achievements</button>
        </div>

        <!-- Marketplace Tab -->
        <div id="marketplace-tab">
            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label>Category</label>
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Min Rating</label>
                    <select id="ratingFilter">
                        <option value="0">Any Rating</option>
                        <option value="4.0">4.0+ Stars</option>
                        <option value="4.5">4.5+ Stars</option>
                        <option value="4.8">4.8+ Stars</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Location</label>
                    <input type="text" id="locationFilter" placeholder="Enter location">
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="searchWorkers()">Search</button>
                </div>
            </div>

            <!-- Workers Grid -->
            <div id="workersGrid" class="workers-grid">
                <div class="loading">Loading workers...</div>
            </div>
        </div>

        <!-- Leaderboards Tab -->
        <div id="leaderboards-tab" style="display: none;">
            <div class="leaderboard">
                <h3>üèÜ Top Earners This Month</h3>
                <div id="topEarners">Loading...</div>
            </div>
            <div class="leaderboard">
                <h3>‚≠ê Best Rated Workers</h3>
                <div id="bestRated">Loading...</div>
            </div>
            <div class="leaderboard">
                <h3>üî• Most Active Workers</h3>
                <div id="mostActive">Loading...</div>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div id="achievements-tab" style="display: none;">
            <div class="leaderboard">
                <h3>üèÖ Available Achievements</h3>
                <div id="achievementsList">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'marketplace';
        let workers = [];
        let categories = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadWorkers();
        });

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            // Load data for the tab
            if (tabName === 'leaderboards') {
                loadLeaderboards();
            } else if (tabName === 'achievements') {
                loadAchievements();
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                
                const select = document.getElementById('categoryFilter');
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = `${category.icon} ${category.name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadWorkers() {
            try {
                const response = await fetch('/api/marketplace/workers?limit=20');
                const data = await response.json();
                
                workers = data.workers || [];
                displayWorkers(workers);
            } catch (error) {
                console.error('Error loading workers:', error);
                document.getElementById('workersGrid').innerHTML = '<div class="loading">Error loading workers</div>';
            }
        }

        function displayWorkers(workersToShow) {
            const grid = document.getElementById('workersGrid');
            
            if (workersToShow.length === 0) {
                grid.innerHTML = '<div class="loading">No workers found</div>';
                return;
            }
            
            grid.innerHTML = workersToShow.map(worker => `
                <div class="worker-card">
                    <div class="worker-header">
                        <div class="worker-avatar">
                            ${worker.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="worker-info">
                            <h3>${worker.name}</h3>
                            <p>${worker.occupation}</p>
                        </div>
                    </div>
                    
                    <div class="worker-stats">
                        <div class="stat">
                            <div class="stat-value">${worker.average_rating.toFixed(1)}</div>
                            <div class="stat-label">Rating</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${worker.review_count}</div>
                            <div class="stat-label">Reviews</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">KSh ${worker.total_tips}</div>
                            <div class="stat-label">Earned</div>
                        </div>
                    </div>
                    
                    <div class="worker-badges">
                        ${worker.worker_profiles?.[0]?.is_verified ? '<span class="badge verified">‚úì Verified</span>' : ''}
                        ${worker.worker_profiles?.[0]?.is_featured ? '<span class="badge featured">‚≠ê Featured</span>' : ''}
                    </div>
                    
                    <div class="worker-services">
                        ${(worker.worker_services || []).map(service => 
                            `<span class="service-tag">${service.service_name}</span>`
                        ).join('')}
                    </div>
                    
                    <div class="worker-actions">
                        <button class="btn btn-primary" onclick="viewProfile('${worker.worker_id}')">
                            View Profile
                        </button>
                        <button class="btn btn-secondary" onclick="followWorker('${worker.worker_id}')">
                            Follow
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function searchWorkers() {
            const category = document.getElementById('categoryFilter').value;
            const rating = document.getElementById('ratingFilter').value;
            const location = document.getElementById('locationFilter').value;
            
            const params = new URLSearchParams();
            if (category) params.append('category', category);
            if (rating) params.append('rating', rating);
            if (location) params.append('location', location);
            
            try {
                const response = await fetch(`/api/marketplace/workers?${params}`);
                const data = await response.json();
                displayWorkers(data.workers || []);
            } catch (error) {
                console.error('Error searching workers:', error);
            }
        }

        async function loadLeaderboards() {
            try {
                const [earners, rated, active] = await Promise.all([
                    fetch('/api/leaderboards/top_earners/monthly').then(r => r.json()),
                    fetch('/api/leaderboards/best_rated/monthly').then(r => r.json()),
                    fetch('/api/leaderboards/most_tips/monthly').then(r => r.json())
                ]);
                
                displayLeaderboard('topEarners', earners.leaderboard || []);
                displayLeaderboard('bestRated', rated.leaderboard || []);
                displayLeaderboard('mostActive', active.leaderboard || []);
            } catch (error) {
                console.error('Error loading leaderboards:', error);
            }
        }

        function displayLeaderboard(elementId, data) {
            const element = document.getElementById(elementId);
            
            if (data.length === 0) {
                element.innerHTML = '<p>No data available</p>';
                return;
            }
            
            element.innerHTML = data.map((item, index) => `
                <div class="leaderboard-item">
                    <div class="rank ${index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : ''}">
                        #${item.rank_position || index + 1}
                    </div>
                    <div class="worker-avatar" style="margin-right: 15px;">
                        ${item.workers?.name?.charAt(0).toUpperCase() || '?'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold;">${item.workers?.name || 'Unknown'}</div>
                        <div style="font-size: 12px; color: #666;">${item.workers?.occupation || ''}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: #667eea;">
                            ${elementId === 'topEarners' ? 'KSh ' + item.score : 
                              elementId === 'bestRated' ? item.score.toFixed(1) + '‚≠ê' : 
                              item.score + ' tips'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadAchievements() {
            try {
                const response = await fetch('/api/achievements/all/worker');
                const data = await response.json();
                
                const element = document.getElementById('achievementsList');
                element.innerHTML = (data.achievements || []).map(achievement => `
                    <div class="leaderboard-item">
                        <div style="font-size: 24px; margin-right: 15px;">
                            ${achievement.achievement_badges?.icon || 'üèÖ'}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold;">${achievement.achievement_badges?.badge_name}</div>
                            <div style="font-size: 12px; color: #666;">${achievement.achievement_badges?.description}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="badge ${achievement.achievement_badges?.rarity}">
                                ${achievement.achievement_badges?.rarity}
                            </div>
                            <div style="font-size: 12px; color: #667eea;">
                                ${achievement.achievement_badges?.points_reward} pts
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading achievements:', error);
            }
        }

        function viewProfile(workerId) {
            window.open(`/worker-profile.html?id=${workerId}`, '_blank');
        }

        async function followWorker(workerId) {
            // This would require customer authentication
            alert('Follow feature requires customer login');
        }
    </script>
</body>
</html>